// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// Admins & System
// ---------------------------------------------------------

model Admin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
}

// ---------------------------------------------------------
// Catalog (Товары и Категории)
// ---------------------------------------------------------

model Category {
  id           String    @id @default(uuid())
  name         String
  isActive     Boolean   @default(true)
  displayOrder Int       @default(0)
  isMold       Boolean   @default(false) // Важно для фильтра "Без плесени"
  products     Product[]
}

model Product {
  id                 String  @id @default(uuid())
  name               String
  sigmaName          String? // Для связи с Sigma (если нужно)
  article            String?
  description        String?
  imageUrl           String?
  priceRub           Int
  unit               String // "kg" или "pcs"
  avgPackWeightGrams Int?    @default(0) // Средний вес куска (важно для калькулятора)
  remainder          Int     // Остаток
  isActive           Boolean @default(true)
  displayOrder       Int     @default(0)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  orderItems     OrderItem[]
  recipeProducts RecipeProduct[]
  productGroups  ProductOnGroup[] // Связь с группами калькулятора

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId, displayOrder])
}

// ---------------------------------------------------------
// Calculator Settings (Настройки калькулятора)
// ---------------------------------------------------------

model ProductGroup {
  id               String  @id @default(uuid())
  name             String
  slug             String? @unique
  isPublic         Boolean @default(false)
  useInConstructor Boolean @default(false) // Участвует ли в калькуляторе
  basePercent      Int     @default(0)     // Процент заполнения тарелки
  displayOrder     Int     @default(0)

  products ProductOnGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductOnGroup {
  productId String
  groupId   String

  product Product      @relation(fields: [productId], references: [id])
  group   ProductGroup @relation(fields: [groupId], references: [id])

  @@id([productId, groupId])
  @@index([groupId])
}

// ---------------------------------------------------------
// Orders (Заказы)
// ---------------------------------------------------------

model Order {
  id String @id @default(uuid())

  customerName    String
  customerPhone   String
  customerAddress String?
  customerComment String?

  // Статусы: "new", "picking", "paid", "completed", "cancelled"
  status         String @default("new")
  // Доставка: "pickup", "delivery"
  deliveryMethod String @default("pickup")

  items OrderItem[]

  totalRub    Int
  deliveryRub Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
}

model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  productName  String
  unit         String
  priceRub     Int
  quantity     Int
  lineTotalRub Int

  createdAt DateTime @default(now())

  @@index([orderId])
}

// ---------------------------------------------------------
// Content: Recipes (Рецепты)
// ---------------------------------------------------------

model RecipeCategory {
  id           String  @id @default(uuid())
  name         String
  isActive     Boolean @default(true)
  displayOrder Int     @default(0)

  recipes Recipe[]
}

model Recipe {
  id               String  @id @default(uuid())
  title            String
  shortDescription String?
  previewImageUrl  String?
  coverUrl         String?
  ingredientsText  String?
  content          String? // HTML или Markdown контент
  isActive         Boolean @default(true)

  categoryId String?
  category   RecipeCategory? @relation(fields: [categoryId], references: [id])

  recipeProducts RecipeProduct[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
}

model RecipeProduct {
  id        String @id @default(uuid())
  recipeId  String
  productId String

  recipe  Recipe  @relation(fields: [recipeId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([recipeId, productId])
  @@index([productId])
}

// ---------------------------------------------------------
// Content: Page Blocks (О нас)
// ---------------------------------------------------------

model PageBlock {
  id           String   @id @default(cuid())
  page         String   @default("about")

  // Типы: "TEXT", "IMAGE_LEFT", "IMAGE_RIGHT", "GALLERY"
  kind         String
  displayOrder Int
  data         String   // JSON stringified
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([page, displayOrder])
}